<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Profit Calculator & Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* Reset and base styles */
        body, h1, h2, h3, label, input {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .app-container {
            background-color: #fff;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            margin-bottom: 20px;
        }
        .wide-container {
            max-width: 800px;
        }
        h1 {
            text-align: center;
            color: #333;
            font-size: 28px;
            margin-bottom: 20px;
        }
        h2 {
            text-align: center;
            color: #333;
            font-size: 24px;
            margin-bottom: 15px;
        }
        h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin-top: 15px;
            font-size: 16px;
            color: #555;
        }
        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-top: 6px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        input:focus {
            outline: none;
            border-color: #007bff;
        }
        .btn {
            width: 100%;
            padding: 15px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 18px;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .btn-danger {
            background-color: #dc3545;
            padding: 8px 12px;
            font-size: 14px;
            width: auto;
            margin: 0;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            color: #333;
            display: none;
        }
        .result.show {
            display: block;
        }
        .result.loss {
            background-color: #ffebee;
        }

        /* Sync code section */
        .sync-code-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .sync-code-section label {
            margin: 0 0 8px 0;
            font-weight: 600;
        }
        .sync-code-input {
            display: flex;
            gap: 10px;
        }
        .sync-code-input input {
            flex: 1;
            margin: 0;
        }
        .sync-code-input .btn {
            width: auto;
            margin: 0;
            padding: 12px 20px;
        }
        .sync-code-help {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }
        .sync-code-display {
            background-color: #e8f5e9;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sync-code-display .code {
            font-weight: 600;
            color: #2e7d32;
        }
        .sync-code-display .btn {
            width: auto;
            margin: 0;
            padding: 8px 15px;
            font-size: 14px;
        }

        /* Sync status indicator */
        .sync-status {
            text-align: center;
            padding: 8px;
            font-size: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .sync-status.synced {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .sync-status.syncing {
            background-color: #fff3e0;
            color: #e65100;
        }
        .sync-status.offline {
            background-color: #ffebee;
            color: #c62828;
        }

        /* Search box */
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-box input {
            flex: 1;
            margin: 0;
        }
        .search-box .btn {
            width: auto;
            margin: 0;
            padding: 12px 20px;
        }

        /* History table */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        .history-table th,
        .history-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .history-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
            position: sticky;
            top: 0;
        }
        .history-table tr:hover {
            background-color: #f8f9fa;
        }
        .history-table .profit-positive {
            color: #28a745;
            font-weight: 600;
        }
        .history-table .profit-negative {
            color: #dc3545;
            font-weight: 600;
        }
        .platform-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .platform-ebay {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        .platform-vinted {
            background-color: #fce4ec;
            color: #c2185b;
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-sold {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .status-refunded {
            background-color: #ffebee;
            color: #c62828;
        }
        .row-refunded {
            background-color: #fff8f8;
            opacity: 0.7;
        }
        .row-refunded td {
            text-decoration: line-through;
            color: #999;
        }
        .row-refunded .status-badge,
        .row-refunded .btn {
            text-decoration: none;
        }
        .btn-warning {
            background-color: #ff9800;
            padding: 8px 12px;
            font-size: 12px;
            width: auto;
            margin: 0;
        }
        .btn-warning:hover {
            background-color: #f57c00;
        }
        .btn-undo {
            background-color: #9e9e9e;
            padding: 8px 12px;
            font-size: 12px;
            width: auto;
            margin: 0;
        }
        .btn-undo:hover {
            background-color: #757575;
        }
        .filter-info {
            background-color: #e3f2fd;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            color: #1565c0;
            font-weight: 500;
        }
        .sync-info {
            background-color: #e8f5e9;
            padding: 12px 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            color: #2e7d32;
            font-size: 14px;
        }
        .table-wrapper {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .no-results {
            text-align: center;
            padding: 30px;
            color: #888;
        }
        .summary {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .summary-item {
            text-align: center;
        }
        .summary-item .label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .summary-item .value {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }
        .summary-item .value.positive {
            color: #28a745;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .action-buttons .btn {
            flex: 1;
            min-width: 120px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            color: #888;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .app-container {
                padding: 20px;
            }
            .history-table {
                font-size: 12px;
            }
            .history-table th,
            .history-table td {
                padding: 8px 4px;
            }
            .summary {
                flex-wrap: wrap;
                gap: 10px;
            }
            .summary-item {
                flex: 1 1 45%;
            }
        }
    </style>
</head>
<body>
    <!-- Calculator Section -->
    <div class="app-container">
        <h1>Profit Calculator</h1>

        <!-- Sync Code Section -->
        <div id="syncCodeSection" class="sync-code-section">
            <label for="syncCode">Your Sync Code:</label>
            <div class="sync-code-input">
                <input type="text" id="syncCode" placeholder="Enter a code (e.g. mycode123)" maxlength="30">
                <button class="btn" onclick="setSyncCode()">Sync</button>
            </div>
            <div class="sync-code-help">Use the same code on all your devices to sync data</div>
        </div>

        <!-- Sync Status -->
        <div id="syncStatus" class="sync-status syncing" style="display:none;">Connecting...</div>

        <!-- Tabs for eBay/Vinted -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('ebay')">eBay</div>
            <div class="tab" onclick="switchTab('vinted')">Vinted</div>
        </div>

        <!-- eBay Form -->
        <div id="ebayTab" class="tab-content active">
            <form onsubmit="calculateEbay(); return false;">
                <label for="ebayDate">Sale Date:</label>
                <input type="date" id="ebayDate" required>

                <label for="ebayItemName">Item Name:</label>
                <input type="text" id="ebayItemName" placeholder="e.g. PS3 Ratatouille" required>

                <label for="ebayNetProceeds">Net Proceeds from eBay (£):</label>
                <input type="number" id="ebayNetProceeds" step="0.01" placeholder="0.00" required>

                <label for="ebayCost">Cost of Goods (£):</label>
                <input type="number" id="ebayCost" step="0.01" placeholder="0.00" required>

                <label for="ebayShipping">Shipping Cost (£):</label>
                <input type="number" id="ebayShipping" step="0.01" placeholder="0.00" required>

                <button type="submit" class="btn">Calculate</button>
            </form>
            <div id="ebayResult" class="result"></div>
            <button class="btn btn-success" id="ebayAddBtn" onclick="addEbayToHistory()" style="display:none;">Add to History</button>
        </div>

        <!-- Vinted Form -->
        <div id="vintedTab" class="tab-content">
            <form onsubmit="calculateVinted(); return false;">
                <label for="vintedDate">Sale Date:</label>
                <input type="date" id="vintedDate" required>

                <label for="vintedItemName">Item Name:</label>
                <input type="text" id="vintedItemName" placeholder="e.g. Nike Trainers" required>

                <label for="vintedSalePrice">Sale Price (£):</label>
                <input type="number" id="vintedSalePrice" step="0.01" placeholder="0.00" required>

                <label for="vintedCost">Cost of Goods (£):</label>
                <input type="number" id="vintedCost" step="0.01" placeholder="0.00" required>

                <button type="submit" class="btn">Calculate</button>
            </form>
            <div id="vintedResult" class="result"></div>
            <button class="btn btn-success" id="vintedAddBtn" onclick="addVintedToHistory()" style="display:none;">Add to History</button>
        </div>
    </div>

    <!-- Sales History Section -->
    <div class="app-container wide-container">
        <h2>Sales History</h2>

        <!-- Date Filter -->
        <div class="search-box">
            <input type="date" id="dateFilter" onchange="filterHistory()">
            <button class="btn btn-secondary" onclick="clearDateFilter()">Show All Dates</button>
        </div>

        <!-- Search -->
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search by item name..." oninput="filterHistory()">
            <button class="btn" onclick="filterHistory()">Search</button>
        </div>

        <!-- Filter Info -->
        <div id="filterInfo" class="filter-info" style="display:none;"></div>

        <!-- Summary Stats -->
        <div class="summary">
            <div class="summary-item">
                <div class="label">Total Sales</div>
                <div class="value" id="totalSales">0</div>
            </div>
            <div class="summary-item">
                <div class="label">Refunds</div>
                <div class="value" id="totalRefunds" style="color: #c62828;">0</div>
            </div>
            <div class="summary-item">
                <div class="label">Total Revenue</div>
                <div class="value" id="totalRevenue">£0.00</div>
            </div>
            <div class="summary-item">
                <div class="label">Total Tax</div>
                <div class="value" id="totalTax">£0.00</div>
            </div>
            <div class="summary-item">
                <div class="label">Net Profit</div>
                <div class="value positive" id="totalProfit">£0.00</div>
            </div>
        </div>

        <!-- History Table -->
        <div class="table-wrapper">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Item</th>
                        <th>Platform</th>
                        <th>Status</th>
                        <th>COG</th>
                        <th>Payout</th>
                        <th>Ship</th>
                        <th>Tax</th>
                        <th>Profit</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                </tbody>
            </table>
            <div class="no-results" id="noResults" style="display:none;">
                No sales found. Add your first sale above!
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="exportCSV()">Export CSV</button>
            <button class="btn btn-danger" onclick="clearAllHistory()">Clear All</button>
        </div>

        <!-- Sync Info -->
        <div class="sync-info">
            <strong>Auto-sync enabled!</strong> Your data syncs automatically between all your devices.
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyD3W4BlPqO8T9r0PkWhbfecbOHZ4aO1vaM",
            authDomain: "profit-calculator-92c66.firebaseapp.com",
            projectId: "profit-calculator-92c66",
            storageBucket: "profit-calculator-92c66.firebasestorage.app",
            messagingSenderId: "641770974955",
            appId: "1:641770974955:web:9ac1ec9f84dcf1a8c8d8ae"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ============================================
        // DATA STORAGE
        // ============================================
        let salesHistory = [];
        let currentEbayCalc = null;
        let currentVintedCalc = null;
        let syncCode = null;
        let unsubscribe = null; // For real-time listener

        // Update sync status display
        function updateSyncStatus(status, message) {
            const el = document.getElementById('syncStatus');
            el.className = 'sync-status ' + status;
            el.textContent = message;
            el.style.display = 'block';
        }

        // Set sync code and connect
        function setSyncCode() {
            const codeInput = document.getElementById('syncCode');
            const code = codeInput.value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');

            if (code.length < 4) {
                alert('Please enter a code with at least 4 characters');
                return;
            }

            syncCode = code;
            localStorage.setItem('syncCode', syncCode);

            // Update UI to show current code
            showSyncCodeDisplay();

            // Connect to Firebase with this code
            connectWithSyncCode();
        }

        // Show the current sync code
        function showSyncCodeDisplay() {
            const section = document.getElementById('syncCodeSection');
            section.innerHTML = `
                <div class="sync-code-display">
                    <span>Sync Code: <span class="code">${syncCode}</span></span>
                    <button class="btn btn-secondary" onclick="changeSyncCode()">Change</button>
                </div>
            `;
        }

        // Allow changing sync code
        function changeSyncCode() {
            // Stop current listener
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }

            // Clear local data
            syncCode = null;
            localStorage.removeItem('syncCode');
            salesHistory = [];
            renderHistory();
            updateSummary();

            // Reset UI
            const section = document.getElementById('syncCodeSection');
            section.innerHTML = `
                <label for="syncCode">Your Sync Code:</label>
                <div class="sync-code-input">
                    <input type="text" id="syncCode" placeholder="Enter a code (e.g. mycode123)" maxlength="30">
                    <button class="btn" onclick="setSyncCode()">Sync</button>
                </div>
                <div class="sync-code-help">Use the same code on all your devices to sync data</div>
            `;
            document.getElementById('syncStatus').style.display = 'none';
        }

        // Connect to Firebase using sync code
        async function connectWithSyncCode() {
            updateSyncStatus('syncing', 'Connecting...');

            try {
                // Sign in anonymously (just to authenticate with Firebase)
                await auth.signInAnonymously();

                // Set up real-time listener using sync code as document ID
                setupRealtimeSync();

            } catch (error) {
                console.error('Auth error:', error);
                updateSyncStatus('offline', 'Offline mode (data saved locally)');
            }
        }

        // Initialize app
        function initializeApp() {
            // Set default dates to today
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('ebayDate').value = today;
            document.getElementById('vintedDate').value = today;

            // Check if we have a saved sync code
            const savedCode = localStorage.getItem('syncCode');

            if (savedCode) {
                syncCode = savedCode;
                showSyncCodeDisplay();
                connectWithSyncCode();
            }

            // Load from localStorage for instant display
            const saved = localStorage.getItem('salesHistory_' + (syncCode || 'local'));
            if (saved) {
                salesHistory = JSON.parse(saved);
                renderHistory();
                updateSummary();
            }
        }

        // Set up real-time sync with Firestore
        function setupRealtimeSync() {
            if (!syncCode) return;

            // Listen for changes in real-time using syncCode as the document ID
            unsubscribe = db.collection('syncCodes').doc(syncCode).collection('sales')
                .orderBy('date', 'desc')
                .onSnapshot((snapshot) => {
                    salesHistory = [];
                    snapshot.forEach(doc => {
                        salesHistory.push({ id: doc.id, ...doc.data() });
                    });

                    // Save to localStorage as backup
                    localStorage.setItem('salesHistory_' + syncCode, JSON.stringify(salesHistory));

                    renderHistory();
                    updateSummary();
                    updateSyncStatus('synced', 'Synced across all devices');
                }, (error) => {
                    console.error('Sync error:', error);
                    updateSyncStatus('offline', 'Offline mode');
                });
        }

        // Save a single sale to Firestore
        async function saveSaleToCloud(sale) {
            if (!syncCode) {
                // Offline mode - just save locally
                salesHistory.unshift(sale);
                localStorage.setItem('salesHistory_local', JSON.stringify(salesHistory));
                renderHistory();
                updateSummary();
                return;
            }

            updateSyncStatus('syncing', 'Saving...');
            try {
                await db.collection('syncCodes').doc(syncCode).collection('sales').add(sale);
                // Real-time listener will update the UI
            } catch (error) {
                console.error('Save error:', error);
                updateSyncStatus('offline', 'Save failed - stored locally');
                salesHistory.unshift(sale);
                localStorage.setItem('salesHistory_' + syncCode, JSON.stringify(salesHistory));
                renderHistory();
                updateSummary();
            }
        }

        // Update a sale in Firestore
        async function updateSaleInCloud(saleId, updates) {
            if (!syncCode || !saleId) return;

            updateSyncStatus('syncing', 'Updating...');
            try {
                await db.collection('syncCodes').doc(syncCode).collection('sales').doc(saleId).update(updates);
            } catch (error) {
                console.error('Update error:', error);
                updateSyncStatus('offline', 'Update failed');
            }
        }

        // Delete a sale from Firestore
        async function deleteSaleFromCloud(saleId) {
            if (!syncCode || !saleId) return;

            updateSyncStatus('syncing', 'Deleting...');
            try {
                await db.collection('syncCodes').doc(syncCode).collection('sales').doc(saleId).delete();
            } catch (error) {
                console.error('Delete error:', error);
                updateSyncStatus('offline', 'Delete failed');
            }
        }

        // Clear all sales from Firestore
        async function clearAllFromCloud() {
            if (!syncCode) return;

            updateSyncStatus('syncing', 'Clearing...');
            try {
                const snapshot = await db.collection('syncCodes').doc(syncCode).collection('sales').get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            } catch (error) {
                console.error('Clear error:', error);
                updateSyncStatus('offline', 'Clear failed');
            }
        }

        // ============================================
        // TAB SWITCHING
        // ============================================
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab:${tab === 'ebay' ? 'first' : 'last'}-child`).classList.add('active');
            document.getElementById('ebayTab').classList.toggle('active', tab === 'ebay');
            document.getElementById('vintedTab').classList.toggle('active', tab === 'vinted');
        }

        // ============================================
        // EBAY CALCULATOR
        // ============================================
        function calculateEbay() {
            const saleDate = document.getElementById('ebayDate').value;
            const itemName = document.getElementById('ebayItemName').value.trim();
            const netProceeds = parseFloat(document.getElementById('ebayNetProceeds').value) || 0;
            const cost = parseFloat(document.getElementById('ebayCost').value) || 0;
            const shipping = parseFloat(document.getElementById('ebayShipping').value) || 0;

            const preTaxProfit = netProceeds - cost - shipping;
            const tax = preTaxProfit > 0 ? preTaxProfit * 0.20 : 0;
            const finalProfit = preTaxProfit - tax;

            // Use selected date (set to noon to avoid timezone issues)
            const selectedDate = new Date(saleDate + 'T12:00:00');

            currentEbayCalc = {
                itemName,
                netProceeds,
                cost,
                shipping,
                preTaxProfit,
                tax,
                finalProfit,
                platform: 'ebay',
                date: selectedDate.toISOString(),
                refunded: false
            };

            const resultDiv = document.getElementById('ebayResult');
            resultDiv.innerHTML = `
                <strong>${itemName}</strong><br>
                Pre-tax Profit: £${preTaxProfit.toFixed(2)}<br>
                Tax (20%): £${tax.toFixed(2)}<br>
                <strong>Final Profit: £${finalProfit.toFixed(2)}</strong>
            `;
            resultDiv.classList.add('show');
            resultDiv.classList.toggle('loss', finalProfit < 0);
            document.getElementById('ebayAddBtn').style.display = 'block';
        }

        function addEbayToHistory() {
            if (currentEbayCalc) {
                saveSaleToCloud(currentEbayCalc);

                // Reset form and set date back to today
                const today = new Date().toISOString().slice(0, 10);
                document.getElementById('ebayDate').value = today;
                document.getElementById('ebayItemName').value = '';
                document.getElementById('ebayNetProceeds').value = '';
                document.getElementById('ebayCost').value = '';
                document.getElementById('ebayShipping').value = '';
                document.getElementById('ebayResult').classList.remove('show');
                document.getElementById('ebayAddBtn').style.display = 'none';
                currentEbayCalc = null;
                document.getElementById('ebayItemName').focus();
            }
        }

        // ============================================
        // VINTED CALCULATOR
        // ============================================
        function calculateVinted() {
            const saleDate = document.getElementById('vintedDate').value;
            const itemName = document.getElementById('vintedItemName').value.trim();
            const salePrice = parseFloat(document.getElementById('vintedSalePrice').value) || 0;
            const cost = parseFloat(document.getElementById('vintedCost').value) || 0;

            const preTaxProfit = salePrice - cost;
            const tax = preTaxProfit > 0 ? preTaxProfit * 0.20 : 0;
            const finalProfit = preTaxProfit - tax;

            // Use selected date (set to noon to avoid timezone issues)
            const selectedDate = new Date(saleDate + 'T12:00:00');

            currentVintedCalc = {
                itemName,
                netProceeds: salePrice,
                cost,
                shipping: 0,
                preTaxProfit,
                tax,
                finalProfit,
                platform: 'vinted',
                date: selectedDate.toISOString(),
                refunded: false
            };

            const resultDiv = document.getElementById('vintedResult');
            resultDiv.innerHTML = `
                <strong>${itemName}</strong><br>
                Pre-tax Profit: £${preTaxProfit.toFixed(2)}<br>
                Tax (20%): £${tax.toFixed(2)}<br>
                <strong>Final Profit: £${finalProfit.toFixed(2)}</strong>
            `;
            resultDiv.classList.add('show');
            resultDiv.classList.toggle('loss', finalProfit < 0);
            document.getElementById('vintedAddBtn').style.display = 'block';
        }

        function addVintedToHistory() {
            if (currentVintedCalc) {
                saveSaleToCloud(currentVintedCalc);

                // Reset form and set date back to today
                const today = new Date().toISOString().slice(0, 10);
                document.getElementById('vintedDate').value = today;
                document.getElementById('vintedItemName').value = '';
                document.getElementById('vintedSalePrice').value = '';
                document.getElementById('vintedCost').value = '';
                document.getElementById('vintedResult').classList.remove('show');
                document.getElementById('vintedAddBtn').style.display = 'none';
                currentVintedCalc = null;
                document.getElementById('vintedItemName').focus();
            }
        }

        // ============================================
        // HISTORY TABLE
        // ============================================
        function renderHistory(filteredData = null) {
            const data = filteredData || salesHistory;
            const tbody = document.getElementById('historyBody');
            const noResults = document.getElementById('noResults');

            if (data.length === 0) {
                tbody.innerHTML = '';
                noResults.style.display = 'block';
                return;
            }

            noResults.style.display = 'none';
            tbody.innerHTML = data.map((sale, index) => {
                const date = new Date(sale.date).toLocaleDateString('en-GB');
                const profitClass = sale.finalProfit >= 0 ? 'profit-positive' : 'profit-negative';
                const platformClass = sale.platform === 'ebay' ? 'platform-ebay' : 'platform-vinted';
                const platformLabel = sale.platform === 'ebay' ? 'eBay' : 'Vinted';
                const isRefunded = sale.refunded === true;
                const statusClass = isRefunded ? 'status-refunded' : 'status-sold';
                const statusLabel = isRefunded ? 'Refunded' : 'Sold';
                const rowClass = isRefunded ? 'row-refunded' : '';

                const saleId = sale.id || index;
                const actionButton = isRefunded
                    ? `<button class="btn btn-undo" onclick="toggleRefund('${saleId}', false)">Undo</button>`
                    : `<button class="btn btn-warning" onclick="toggleRefund('${saleId}', true)">Refund</button>`;

                return `
                    <tr class="${rowClass}">
                        <td>${date}</td>
                        <td>${sale.itemName}</td>
                        <td><span class="platform-badge ${platformClass}">${platformLabel}</span></td>
                        <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                        <td>£${sale.cost.toFixed(2)}</td>
                        <td>£${sale.netProceeds.toFixed(2)}</td>
                        <td>£${sale.shipping.toFixed(2)}</td>
                        <td>£${sale.tax.toFixed(2)}</td>
                        <td class="${profitClass}">£${sale.finalProfit.toFixed(2)}</td>
                        <td>
                            ${actionButton}
                            <button class="btn btn-danger" onclick="deleteSale('${saleId}')">X</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // REFUND TOGGLE
        // ============================================
        function toggleRefund(saleId, setRefunded) {
            const sale = salesHistory.find(s => s.id === saleId);
            if (!sale) return;

            const action = setRefunded ? 'mark as refunded' : 'mark as sold again';
            if (confirm(`Are you sure you want to ${action} "${sale.itemName}"?`)) {
                updateSaleInCloud(saleId, { refunded: setRefunded });
            }
        }

        // ============================================
        // SEARCH / FILTER
        // ============================================
        function filterHistory() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const dateFilter = document.getElementById('dateFilter').value;
            const filterInfo = document.getElementById('filterInfo');

            let filtered = salesHistory;

            if (dateFilter) {
                filtered = filtered.filter(sale => {
                    const saleDate = new Date(sale.date).toISOString().slice(0, 10);
                    return saleDate === dateFilter;
                });

                const displayDate = new Date(dateFilter).toLocaleDateString('en-GB', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
                filterInfo.innerHTML = `Showing sales for <strong>${displayDate}</strong>`;
                filterInfo.style.display = 'block';
            } else {
                filterInfo.style.display = 'none';
            }

            if (searchTerm) {
                filtered = filtered.filter(sale =>
                    sale.itemName.toLowerCase().includes(searchTerm)
                );
            }

            renderHistory(filtered);
            updateSummary(filtered);
        }

        function clearDateFilter() {
            document.getElementById('dateFilter').value = '';
            document.getElementById('searchInput').value = '';
            filterHistory();
        }

        // ============================================
        // SUMMARY STATS
        // ============================================
        function updateSummary(data = null) {
            const sales = data || salesHistory;
            const soldItems = sales.filter(s => !s.refunded);
            const refundedItems = sales.filter(s => s.refunded);

            const totalSales = soldItems.length;
            const totalRefunds = refundedItems.length;
            const totalRevenue = soldItems.reduce((sum, s) => sum + s.netProceeds, 0);
            const totalTax = soldItems.reduce((sum, s) => sum + s.tax, 0);
            const totalProfit = soldItems.reduce((sum, s) => sum + s.finalProfit, 0);

            document.getElementById('totalSales').textContent = totalSales;
            document.getElementById('totalRefunds').textContent = totalRefunds;
            document.getElementById('totalRevenue').textContent = '£' + totalRevenue.toFixed(2);
            document.getElementById('totalTax').textContent = '£' + totalTax.toFixed(2);
            document.getElementById('totalProfit').textContent = '£' + totalProfit.toFixed(2);

            const profitEl = document.getElementById('totalProfit');
            profitEl.classList.toggle('positive', totalProfit >= 0);
        }

        // ============================================
        // DELETE / CLEAR
        // ============================================
        function deleteSale(saleId) {
            if (confirm('Delete this sale?')) {
                deleteSaleFromCloud(saleId);
            }
        }

        function clearAllHistory() {
            if (confirm('Delete ALL sales history? This cannot be undone!')) {
                clearAllFromCloud();
                localStorage.removeItem('salesHistory');
            }
        }

        // ============================================
        // EXPORT TO CSV
        // ============================================
        function exportCSV() {
            if (salesHistory.length === 0) {
                alert('No sales to export!');
                return;
            }

            let csv = 'Date,Item Name,Platform,Status,Cost of Goods,Net Proceeds,Shipping,Tax,Final Profit\n';

            salesHistory.forEach(sale => {
                const date = new Date(sale.date).toLocaleDateString('en-GB');
                const status = sale.refunded ? 'Refunded' : 'Sold';
                csv += `"${date}","${sale.itemName}","${sale.platform}","${status}",${sale.cost.toFixed(2)},${sale.netProceeds.toFixed(2)},${sale.shipping.toFixed(2)},${sale.tax.toFixed(2)},${sale.finalProfit.toFixed(2)}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sales_history_' + new Date().toISOString().slice(0,10) + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============================================
        // INITIALIZE
        // ============================================
        initializeApp();
    </script>
</body>
</html>
